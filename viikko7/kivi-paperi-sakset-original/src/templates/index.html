<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kivi-Paperi-Sakset</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸª¨ ğŸ“„ âœ‚ï¸ Kivi-Paperi-Sakset</h1>
        
        <div id="mode-selection" class="section">
            <h2>Valitse pelimuoto:</h2>
            <div class="button-group">
                <button onclick="startGame('a')" class="mode-btn">
                    ğŸ‘¥ Pelaaja vs Pelaaja
                </button>
                <button onclick="startGame('b')" class="mode-btn">
                    ğŸ¤– Pelaaja vs TekoÃ¤ly
                </button>
                <button onclick="startGame('c')" class="mode-btn">
                    ğŸ§  Pelaaja vs Parannettu TekoÃ¤ly
                </button>
            </div>
        </div>

        <div id="game-area" class="section" style="display: none;">
            <h2 id="mode-name">Pelimuoto</h2>
            
            <div class="scores">
                <div class="score-box">
                    <h3>Pelaaja 1</h3>
                    <div class="score" id="score1">0</div>
                    <div class="streak-info">
                        <div class="streak">PerÃ¤kkÃ¤isiÃ¤: <span id="streak1">0</span>/3</div>
                        <div class="wins-needed">ğŸ“Š <span id="wins-needed1">3</span> voittoa enÃ¤Ã¤!</div>
                    </div>
                </div>
                <div class="score-box">
                    <h3>Tasapelit</h3>
                    <div class="score" id="ties">0</div>
                </div>
                <div class="score-box">
                    <h3><span id="player2-label">Pelaaja 2</span></h3>
                    <div class="score" id="score2">0</div>
                    <div class="streak-info">
                        <div class="streak">PerÃ¤kkÃ¤isiÃ¤: <span id="streak2">0</span>/3</div>
                        <div class="wins-needed">ğŸ“Š <span id="wins-needed2">3</span> voittoa enÃ¤Ã¤!</div>
                    </div>
                </div>
            </div>

            <div id="game-info" class="game-info">
                ğŸ¯ Tavoite: Voita 3 kertaa perÃ¤kkÃ¤in!
            </div>

            <div class="game-controls">
                <div class="player-section">
                    <h3>Pelaaja 1 - Valitse siirtosi:</h3>
                    <div class="move-buttons">
                        <button onclick="selectMove('player1', 'k')" class="move-btn" data-player="player1" data-move="k">
                            ğŸª¨<br>Kivi
                        </button>
                        <button onclick="selectMove('player1', 'p')" class="move-btn" data-player="player1" data-move="p">
                            ğŸ“„<br>Paperi
                        </button>
                        <button onclick="selectMove('player1', 's')" class="move-btn" data-player="player1" data-move="s">
                            âœ‚ï¸<br>Sakset
                        </button>
                    </div>
                </div>

                <div id="player2-section" class="player-section">
                    <h3>Pelaaja 2 - Valitse siirtosi:</h3>
                    <div class="move-buttons">
                        <button onclick="selectMove('player2', 'k')" class="move-btn" data-player="player2" data-move="k">
                            ğŸª¨<br>Kivi
                        </button>
                        <button onclick="selectMove('player2', 'p')" class="move-btn" data-player="player2" data-move="p">
                            ğŸ“„<br>Paperi
                        </button>
                        <button onclick="selectMove('player2', 's')" class="move-btn" data-player="player2" data-move="s">
                            âœ‚ï¸<br>Sakset
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-area" class="result-area" style="display: none;">
                <h3>Tulokset:</h3>
                <div class="result-display">
                    <div class="move-result">
                        <h4>Pelaaja 1</h4>
                        <div id="p1-move" class="move-display"></div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="move-result">
                        <h4 id="p2-result-label">Pelaaja 2</h4>
                        <div id="p2-move" class="move-display"></div>
                    </div>
                </div>
                <div id="round-result" class="round-result"></div>
                <div id="continue-buttons">
                    <button onclick="nextRound()" class="action-btn">Seuraava kierros</button>
                </div>
            </div>

            <div id="game-over" class="game-over" style="display: none;">
                <h2>ğŸ† Peli pÃ¤Ã¤ttyi!</h2>
                <div id="winner-announcement"></div>
                <button onclick="resetGame()" class="action-btn">Pelaa uudestaan</button>
            </div>

            <div class="action-buttons">
                <button onclick="resetGame()" class="reset-btn">Aloita alusta</button>
            </div>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        let gameMode = null;
        let player1Move = null;
        let player2Move = null;

        function startGame(mode) {
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    gameMode = mode;
                    document.getElementById('mode-selection').style.display = 'none';
                    document.getElementById('game-area').style.display = 'block';
                    document.getElementById('mode-name').textContent = data.mode_name;
                    
                    // Hide player 2 section for AI modes
                    if (mode === 'b' || mode === 'c') {
                        document.getElementById('player2-section').style.display = 'none';
                        document.getElementById('player2-label').textContent = 'Tietokone';
                        document.getElementById('p2-result-label').textContent = 'Tietokone';
                    } else {
                        document.getElementById('player2-section').style.display = 'block';
                        document.getElementById('player2-label').textContent = 'Pelaaja 2';
                        document.getElementById('p2-result-label').textContent = 'Pelaaja 2';
                    }
                    
                    resetRound();
                }
            });
        }

        function selectMove(player, move) {
            if (player === 'player1') {
                player1Move = move;
                // Highlight selected button
                document.querySelectorAll('[data-player="player1"]').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.closest('button').classList.add('selected');
                
                // For AI modes, automatically make the move
                if (gameMode === 'b' || gameMode === 'c') {
                    makeMove();
                }
            } else if (player === 'player2') {
                player2Move = move;
                // Highlight selected button
                document.querySelectorAll('[data-player="player2"]').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.closest('button').classList.add('selected');
                
                // Check if both players have selected
                if (player1Move && player2Move) {
                    makeMove();
                }
            }
        }

        function makeMove() {
            let data = { player1_move: player1Move };
            
            if (gameMode === 'a') {
                if (!player2Move) return;
                data.player2_move = player2Move;
            }
            
            fetch('/make_move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update scores
                    document.getElementById('score1').textContent = data.scores.player1;
                    document.getElementById('score2').textContent = data.scores.player2;
                    document.getElementById('ties').textContent = data.scores.ties;
                    document.getElementById('streak1').textContent = data.scores.player1_streak;
                    document.getElementById('streak2').textContent = data.scores.player2_streak;
                    
                    // Update wins needed counters
                    const winsNeeded1 = Math.max(0, 5 - data.scores.player1_streak);
                    const winsNeeded2 = Math.max(0, 5 - data.scores.player2_streak);
                    document.getElementById('wins-needed1').textContent = winsNeeded1;
                    document.getElementById('wins-needed2').textContent = winsNeeded2;
                    
                    // Show results
                    const moveIcons = { 'k': 'ğŸª¨ Kivi', 'p': 'ğŸ“„ Paperi', 's': 'âœ‚ï¸ Sakset' };
                    document.getElementById('p1-move').textContent = moveIcons[data.player1_move];
                    document.getElementById('p2-move').textContent = moveIcons[data.player2_move];
                    
                    // Determine round result
                    let roundResult = '';
                    if (data.scores.player1_streak > 0 && data.scores.player2_streak === 0 && data.scores.ties === 0) {
                        roundResult = 'ğŸ‰ Pelaaja 1 voitti kierroksen!';
                    } else if (data.scores.player2_streak > 0 && data.scores.player1_streak === 0) {
                        const player2Name = gameMode === 'a' ? 'Pelaaja 2' : 'Tietokone';
                        roundResult = `ğŸ‰ ${player2Name} voitti kierroksen!`;
                    } else if (data.scores.ties > 0) {
                        roundResult = 'ğŸ¤ Tasapeli!';
                    }
                    document.getElementById('round-result').textContent = roundResult;
                    
                    // Hide game controls and show results
                    document.querySelector('.game-controls').style.display = 'none';
                    document.getElementById('result-area').style.display = 'block';
                    
                    // Check if game is over
                    if (data.game_over) {
                        document.getElementById('continue-buttons').style.display = 'none';
                        showGameOver(data.winner);
                    }
                } else {
                    showMessage(data.error, 'error');
                }
            });
        }

        function showGameOver(winner) {
            const player2Name = gameMode === 'a' ? 'Pelaaja 2' : 'Tietokone';
            const winnerName = winner === 1 ? 'Pelaaja 1' : player2Name;
            
            document.getElementById('winner-announcement').innerHTML = 
                `<p class="winner-text">ğŸ† ${winnerName} voitti 3 kertaa perÃ¤kkÃ¤in!</p>` +
                `<p>Onnea voittajalle! ğŸŠ</p>`;
            
            setTimeout(() => {
                document.getElementById('result-area').style.display = 'none';
                document.getElementById('game-over').style.display = 'block';
            }, 2000);
        }

        function nextRound() {
            resetRound();
        }

        function resetRound() {
            player1Move = null;
            player2Move = null;
            
            // Clear selections
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Show game controls and hide results
            document.querySelector('.game-controls').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';
        }

        function resetGame() {
            fetch('/reset_game', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset UI
                    document.getElementById('mode-selection').style.display = 'block';
                    document.getElementById('game-area').style.display = 'none';
                    document.getElementById('game-over').style.display = 'none';
                    document.getElementById('score1').textContent = '0';
                    document.getElementById('score2').textContent = '0';
                    document.getElementById('ties').textContent = '0';
                    document.getElementById('streak1').textContent = '0';
                    document.getElementById('streak2').textContent = '0';
                    document.getElementById('wins-needed1').textContent = '3';
                    document.getElementById('wins-needed2').textContent = '3';
                    document.getElementById('continue-buttons').style.display = 'block';
                    gameMode = null;
                    resetRound();
                }
            });
        }

        function showMessage(msg, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = msg;
            messageEl.className = 'message ' + type;
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 3000);
        }
    </script>
</body>
</html>
